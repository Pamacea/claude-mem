#!/usr/bin/env bun
"use strict";var X=Object.create;var O=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var B=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var Y=(s,t)=>{for(var e in t)O(s,e,{get:t[e],enumerable:!0})},I=(s,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of V(t))!j.call(s,n)&&n!==e&&O(s,n,{get:()=>t[n],enumerable:!(r=K(t,n))||r.enumerable});return s};var J=(s,t,e)=>(e=s!=null?X(B(s)):{},I(t||!s||!s.__esModule?O(e,"default",{value:s,enumerable:!0}):e,s)),z=s=>I(O({},"__esModule",{value:!0}),s);var et={};Y(et,{handleStop:()=>tt});module.exports=z(et);var L={DEFAULT:3e4,HEALTH_CHECK:3e4,WORKER_STARTUP_WAIT:1e4,WORKER_STARTUP_RETRIES:30,PRE_RESTART_SETTLE_DELAY:2e4,POWERSHELL_COMMAND:1e4,WINDOWS_MULTIPLIER:1.5};function h(){return Date.now().toString(36)+Math.random().toString(36).substring(2,11)}function N(s){return process.platform==="win32"?Math.round(s*L.WINDOWS_MULTIPLIER):s}var H=J(require("path"),1);var c=require("fs"),T=require("path"),P=require("os"),C=(o=>(o[o.DEBUG=0]="DEBUG",o[o.INFO=1]="INFO",o[o.WARN=2]="WARN",o[o.ERROR=3]="ERROR",o[o.SILENT=4]="SILENT",o))(C||{}),y=(0,T.join)((0,P.homedir)(),".claude-mem"),m=class{level=null;useColor;logFilePath=null;logFileInitialized=!1;constructor(){this.useColor=process.stdout.isTTY??!1}ensureLogFileInitialized(){if(!this.logFileInitialized){this.logFileInitialized=!0;try{let t=(0,T.join)(y,"logs");(0,c.existsSync)(t)||(0,c.mkdirSync)(t,{recursive:!0});let e=new Date().toISOString().split("T")[0];this.logFilePath=(0,T.join)(t,`claude-mem-${e}.log`)}catch(t){console.error("[LOGGER] Failed to initialize log file:",t),this.logFilePath=null}}}getLevel(){if(this.level===null)try{let t=(0,T.join)(y,"settings.json");if((0,c.existsSync)(t)){let e=(0,c.readFileSync)(t,"utf-8"),n=(JSON.parse(e).CLAUDE_MEM_LOG_LEVEL||"INFO").toUpperCase();this.level=C[n]??1}else this.level=1}catch{this.level=1}return this.level}correlationId(t,e){return`obs-${t}-${e}`}sessionId(t){return`session-${t}`}formatData(t){if(t==null)return"";if(typeof t=="string")return t;if(typeof t=="number"||typeof t=="boolean")return t.toString();if(typeof t=="object"){if(t instanceof Error)return this.getLevel()===0?`${t.message}
${t.stack}`:t.message;if(Array.isArray(t))return`[${t.length} items]`;let e=Object.keys(t);return e.length===0?"{}":e.length<=3?JSON.stringify(t):`{${e.length} keys: ${e.slice(0,3).join(", ")}...}`}return String(t)}formatTool(t,e){if(!e)return t;let r=e;if(typeof e=="string")try{r=JSON.parse(e)}catch{r=e}if(t==="Bash"&&r.command)return`${t}(${r.command})`;if(r.file_path)return`${t}(${r.file_path})`;if(r.notebook_path)return`${t}(${r.notebook_path})`;if(t==="Glob"&&r.pattern)return`${t}(${r.pattern})`;if(t==="Grep"&&r.pattern)return`${t}(${r.pattern})`;if(r.url)return`${t}(${r.url})`;if(r.query)return`${t}(${r.query})`;if(t==="Task"){if(r.subagent_type)return`${t}(${r.subagent_type})`;if(r.description)return`${t}(${r.description})`}return t==="Skill"&&r.skill?`${t}(${r.skill})`:t==="LSP"&&r.operation?`${t}(${r.operation})`:t}formatTimestamp(t){let e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),o=String(t.getHours()).padStart(2,"0"),E=String(t.getMinutes()).padStart(2,"0"),a=String(t.getSeconds()).padStart(2,"0"),p=String(t.getMilliseconds()).padStart(3,"0");return`${e}-${r}-${n} ${o}:${E}:${a}.${p}`}log(t,e,r,n,o){if(t<this.getLevel())return;this.ensureLogFileInitialized();let E=this.formatTimestamp(new Date),a=C[t].padEnd(5),p=e.padEnd(6),g="";n?.correlationId?g=`[${n.correlationId}] `:n?.sessionId&&(g=`[session-${n.sessionId}] `);let S="";o!=null&&(o instanceof Error?S=this.getLevel()===0?`
${o.message}
${o.stack}`:` ${o.message}`:this.getLevel()===0&&typeof o=="object"?S=`
`+JSON.stringify(o,null,2):S=" "+this.formatData(o));let M="";if(n){let{sessionId:R,memorySessionId:rt,correlationId:nt,...d}=n;Object.keys(d).length>0&&(M=` {${Object.entries(d).map(([G,W])=>`${G}=${W}`).join(", ")}}`)}let U=`[${E}] [${a}] [${p}] ${g}${r}${M}${S}`;if(this.logFilePath)try{(0,c.appendFileSync)(this.logFilePath,U+`
`,"utf8")}catch(R){process.stderr.write(`[LOGGER] Failed to write to log file: ${R}
`)}else process.stderr.write(U+`
`)}debug(t,e,r,n){this.log(0,t,e,r,n)}info(t,e,r,n){this.log(1,t,e,r,n)}warn(t,e,r,n){this.log(2,t,e,r,n)}error(t,e,r,n){this.log(3,t,e,r,n)}dataIn(t,e,r,n){this.info(t,`\u2192 ${e}`,r,n)}dataOut(t,e,r,n){this.info(t,`\u2190 ${e}`,r,n)}success(t,e,r,n){this.info(t,`\u2713 ${e}`,r,n)}failure(t,e,r,n){this.error(t,`\u2717 ${e}`,r,n)}timing(t,e,r,n){this.info(t,`\u23F1 ${e}`,n,{duration:`${r}ms`})}happyPathError(t,e,r,n,o=""){let g=((new Error().stack||"").split(`
`)[2]||"").match(/at\s+(?:.*\s+)?\(?([^:]+):(\d+):(\d+)\)?/),S=g?`${g[1].split("/").pop()}:${g[2]}`:"unknown",M={...r,location:S};return this.warn(t,`[HAPPY-PATH] ${e}`,M,n),o}},v=new m;var _=require("fs"),D=require("path"),F=require("os");var $="bugfix,feature,refactor,discovery,decision,change",k="how-it-works,why-it-exists,what-changed,problem-solution,gotcha,pattern,trade-off";var u=class{static DEFAULTS={CLAUDE_MEM_MODEL:"claude-sonnet-4-5",CLAUDE_MEM_CONTEXT_OBSERVATIONS:"50",CLAUDE_MEM_WORKER_PORT:"37777",CLAUDE_MEM_WORKER_HOST:process.platform==="win32"?"0.0.0.0":"127.0.0.1",CLAUDE_MEM_SKIP_TOOLS:"ListMcpResourcesTool,SlashCommand,Skill,TodoWrite,AskUserQuestion",CLAUDE_MEM_PROVIDER:"claude",CLAUDE_MEM_CLAUDE_AUTH_METHOD:"cli",CLAUDE_MEM_GEMINI_API_KEY:"",CLAUDE_MEM_GEMINI_MODEL:"gemini-2.5-flash-lite",CLAUDE_MEM_GEMINI_RATE_LIMITING_ENABLED:"true",CLAUDE_MEM_OPENROUTER_API_KEY:"",CLAUDE_MEM_OPENROUTER_MODEL:"xiaomi/mimo-v2-flash:free",CLAUDE_MEM_OPENROUTER_SITE_URL:"",CLAUDE_MEM_OPENROUTER_APP_NAME:"claude-mem",CLAUDE_MEM_OPENROUTER_MAX_CONTEXT_MESSAGES:"20",CLAUDE_MEM_OPENROUTER_MAX_TOKENS:"100000",CLAUDE_MEM_DATA_DIR:(0,D.join)((0,F.homedir)(),".claude-mem"),CLAUDE_MEM_LOG_LEVEL:"INFO",CLAUDE_MEM_PYTHON_VERSION:"3.13",CLAUDE_CODE_PATH:"",CLAUDE_MEM_MODE:"code",CLAUDE_MEM_CONTEXT_SHOW_READ_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_WORK_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_AMOUNT:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_PERCENT:"true",CLAUDE_MEM_CONTEXT_OBSERVATION_TYPES:$,CLAUDE_MEM_CONTEXT_OBSERVATION_CONCEPTS:k,CLAUDE_MEM_CONTEXT_FULL_COUNT:"5",CLAUDE_MEM_CONTEXT_FULL_FIELD:"narrative",CLAUDE_MEM_CONTEXT_SESSION_COUNT:"10",CLAUDE_MEM_CONTEXT_SHOW_LAST_SUMMARY:"true",CLAUDE_MEM_CONTEXT_SHOW_LAST_MESSAGE:"false",CLAUDE_MEM_FOLDER_CLAUDEMD_ENABLED:"false",CLAUDE_MEM_EXCLUDED_PROJECTS:"",CLAUDE_MEM_FOLDER_MD_EXCLUDE:"[]"};static getAllDefaults(){return{...this.DEFAULTS}}static get(t){return this.DEFAULTS[t]}static getInt(t){let e=this.get(t);return parseInt(e,10)}static getBool(t){let e=this.get(t);return e==="true"||e===!0}static applyEnvOverrides(t){let e={...t};for(let r of Object.keys(this.DEFAULTS))process.env[r]!==void 0&&(e[r]=process.env[r]);return e}static loadFromFile(t){try{if(!(0,_.existsSync)(t)){let E=this.getAllDefaults();try{let a=(0,D.dirname)(t);(0,_.existsSync)(a)||(0,_.mkdirSync)(a,{recursive:!0}),(0,_.writeFileSync)(t,JSON.stringify(E,null,2),"utf-8"),console.log("[SETTINGS] Created settings file with defaults:",t)}catch(a){console.warn("[SETTINGS] Failed to create settings file, using in-memory defaults:",t,a)}return this.applyEnvOverrides(E)}let e=(0,_.readFileSync)(t,"utf-8"),r=JSON.parse(e),n=r;if(r.env&&typeof r.env=="object"){n=r.env;try{(0,_.writeFileSync)(t,JSON.stringify(n,null,2),"utf-8"),console.log("[SETTINGS] Migrated settings file from nested to flat schema:",t)}catch(E){console.warn("[SETTINGS] Failed to auto-migrate settings file:",t,E)}}let o={...this.DEFAULTS};for(let E of Object.keys(this.DEFAULTS))n[E]!==void 0&&(o[E]=n[E]);return this.applyEnvOverrides(o)}catch(e){return console.warn("[SETTINGS] Failed to load settings, using defaults:",t,e),this.applyEnvOverrides(this.getAllDefaults())}}};var i=require("path"),x=require("os");var w=require("url");var Z={};function q(){return typeof __dirname<"u"?__dirname:(0,i.dirname)((0,w.fileURLToPath)(Z.url))}var St=q(),l=u.get("CLAUDE_MEM_DATA_DIR"),f=process.env.CLAUDE_CONFIG_DIR||(0,i.join)((0,x.homedir)(),".claude"),Q=(0,i.join)(f,"plugins","marketplaces","claude-mem"),Tt=(0,i.join)(l,"archives"),pt=(0,i.join)(l,"logs"),Mt=(0,i.join)(l,"trash"),Ot=(0,i.join)(l,"backups"),Dt=(0,i.join)(l,"modes"),ft=(0,i.join)(l,"settings.json"),At=(0,i.join)(l,"claude-mem.db"),Lt=(0,i.join)(l,"vector-db"),Ct=(0,i.join)(l,"observer-sessions"),mt=(0,i.join)(f,"settings.json"),Ut=(0,i.join)(f,"commands"),Rt=(0,i.join)(f,"CLAUDE.md");var Pt=N(L.HEALTH_CHECK);var A=null;function b(){if(A!==null)return A;let s=H.default.join(u.get("CLAUDE_MEM_DATA_DIR"),"settings.json"),t=u.loadFromFile(s);return A=parseInt(t.CLAUDE_MEM_WORKER_PORT,10),A}async function tt(){try{let s=h(),t=b(),e=await fetch(`http://127.0.0.1:${t}/api/sessions/${s}/prepare`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!e.ok)throw new Error(`Failed to prepare session: ${e.status}`);return console.log(JSON.stringify({continue:!1,suppressOutput:!0,message:"Session stopped"})),0}catch(s){return console.error(JSON.stringify({error:s instanceof Error?s.message:String(s),exitCode:2})),2}}0&&(module.exports={handleStop});
