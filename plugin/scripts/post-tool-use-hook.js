#!/usr/bin/env bun
"use strict";var j=Object.create;var M=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var z=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var Q=(s,t)=>()=>(s&&(t=s(s=0)),t);var I=(s,t)=>{for(var r in t)M(s,r,{get:t[r],enumerable:!0})},h=(s,t,r,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of J(t))!q.call(s,n)&&n!==r&&M(s,n,{get:()=>t[n],enumerable:!(e=Y(t,n))||e.enumerable});return s};var Z=(s,t,r)=>(r=s!=null?j(z(s)):{},h(t||!s||!s.__esModule?M(r,"default",{value:s,enumerable:!0}):r,s)),tt=s=>h(M({},"__esModule",{value:!0}),s);var X={};I(X,{readJsonFromStdin:()=>Et});function st(){try{let s=process.stdin;return s.isTTY?!1:(s.readable,!0)}catch{return!1}}function ot(s){let t=s.trim();if(!t)return{success:!1};try{return{success:!0,value:JSON.parse(t)}}catch{return{success:!1}}}async function Et(){if(st())return new Promise((s,t)=>{let r="",e=!1,n=null,o=()=>{try{process.stdin.removeAllListeners("data"),process.stdin.removeAllListeners("end"),process.stdin.removeAllListeners("error")}catch{}},i=_=>{e||(e=!0,n&&clearTimeout(n),clearTimeout(a),o(),s(_))},c=_=>{e||(e=!0,n&&clearTimeout(n),clearTimeout(a),o(),t(_))},u=()=>{let _=ot(r);return _.success?(i(_.value),!0):!1},a=setTimeout(()=>{e||u()||(r.trim()?c(new Error(`Incomplete JSON after ${W}ms: ${r.slice(0,100)}...`)):i(void 0))},W);try{process.stdin.on("data",_=>{r+=_,n&&(clearTimeout(n),n=null),!u()&&(n=setTimeout(()=>{u()},it))}),process.stdin.on("end",()=>{e||u()||i((r.trim(),void 0))}),process.stdin.on("error",()=>{e||i(void 0)})}catch{e=!0,clearTimeout(a),o(),s(void 0)}})}var W,it,K=Q(()=>{"use strict";W=3e4,it=50});var ct={};I(ct,{handlePostToolUse:()=>_t});module.exports=tt(ct);var L={DEFAULT:3e4,HEALTH_CHECK:3e4,WORKER_STARTUP_WAIT:1e4,WORKER_STARTUP_RETRIES:30,PRE_RESTART_SETTLE_DELAY:2e4,POWERSHELL_COMMAND:1e4,WINDOWS_MULTIPLIER:1.5};function N(){return Date.now().toString(36)+Math.random().toString(36).substring(2,11)}function y(s){return process.platform==="win32"?Math.round(s*L.WINDOWS_MULTIPLIER):s}var H=Z(require("path"),1);var g=require("fs"),S=require("path"),P=require("os"),C=(o=>(o[o.DEBUG=0]="DEBUG",o[o.INFO=1]="INFO",o[o.WARN=2]="WARN",o[o.ERROR=3]="ERROR",o[o.SILENT=4]="SILENT",o))(C||{}),v=(0,S.join)((0,P.homedir)(),".claude-mem"),m=class{level=null;useColor;logFilePath=null;logFileInitialized=!1;constructor(){this.useColor=process.stdout.isTTY??!1}ensureLogFileInitialized(){if(!this.logFileInitialized){this.logFileInitialized=!0;try{let t=(0,S.join)(v,"logs");(0,g.existsSync)(t)||(0,g.mkdirSync)(t,{recursive:!0});let r=new Date().toISOString().split("T")[0];this.logFilePath=(0,S.join)(t,`claude-mem-${r}.log`)}catch(t){console.error("[LOGGER] Failed to initialize log file:",t),this.logFilePath=null}}}getLevel(){if(this.level===null)try{let t=(0,S.join)(v,"settings.json");if((0,g.existsSync)(t)){let r=(0,g.readFileSync)(t,"utf-8"),n=(JSON.parse(r).CLAUDE_MEM_LOG_LEVEL||"INFO").toUpperCase();this.level=C[n]??1}else this.level=1}catch{this.level=1}return this.level}correlationId(t,r){return`obs-${t}-${r}`}sessionId(t){return`session-${t}`}formatData(t){if(t==null)return"";if(typeof t=="string")return t;if(typeof t=="number"||typeof t=="boolean")return t.toString();if(typeof t=="object"){if(t instanceof Error)return this.getLevel()===0?`${t.message}
${t.stack}`:t.message;if(Array.isArray(t))return`[${t.length} items]`;let r=Object.keys(t);return r.length===0?"{}":r.length<=3?JSON.stringify(t):`{${r.length} keys: ${r.slice(0,3).join(", ")}...}`}return String(t)}formatTool(t,r){if(!r)return t;let e=r;if(typeof r=="string")try{e=JSON.parse(r)}catch{e=r}if(t==="Bash"&&e.command)return`${t}(${e.command})`;if(e.file_path)return`${t}(${e.file_path})`;if(e.notebook_path)return`${t}(${e.notebook_path})`;if(t==="Glob"&&e.pattern)return`${t}(${e.pattern})`;if(t==="Grep"&&e.pattern)return`${t}(${e.pattern})`;if(e.url)return`${t}(${e.url})`;if(e.query)return`${t}(${e.query})`;if(t==="Task"){if(e.subagent_type)return`${t}(${e.subagent_type})`;if(e.description)return`${t}(${e.description})`}return t==="Skill"&&e.skill?`${t}(${e.skill})`:t==="LSP"&&e.operation?`${t}(${e.operation})`:t}formatTimestamp(t){let r=t.getFullYear(),e=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),o=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0"),c=String(t.getSeconds()).padStart(2,"0"),u=String(t.getMilliseconds()).padStart(3,"0");return`${r}-${e}-${n} ${o}:${i}:${c}.${u}`}log(t,r,e,n,o){if(t<this.getLevel())return;this.ensureLogFileInitialized();let i=this.formatTimestamp(new Date),c=C[t].padEnd(5),u=r.padEnd(6),a="";n?.correlationId?a=`[${n.correlationId}] `:n?.sessionId&&(a=`[session-${n.sessionId}] `);let _="";o!=null&&(o instanceof Error?_=this.getLevel()===0?`
${o.message}
${o.stack}`:` ${o.message}`:this.getLevel()===0&&typeof o=="object"?_=`
`+JSON.stringify(o,null,2):_=" "+this.formatData(o));let p="";if(n){let{sessionId:U,memorySessionId:at,correlationId:lt,...R}=n;Object.keys(R).length>0&&(p=` {${Object.entries(R).map(([V,B])=>`${V}=${B}`).join(", ")}}`)}let d=`[${i}] [${c}] [${u}] ${a}${e}${p}${_}`;if(this.logFilePath)try{(0,g.appendFileSync)(this.logFilePath,d+`
`,"utf8")}catch(U){process.stderr.write(`[LOGGER] Failed to write to log file: ${U}
`)}else process.stderr.write(d+`
`)}debug(t,r,e,n){this.log(0,t,r,e,n)}info(t,r,e,n){this.log(1,t,r,e,n)}warn(t,r,e,n){this.log(2,t,r,e,n)}error(t,r,e,n){this.log(3,t,r,e,n)}dataIn(t,r,e,n){this.info(t,`\u2192 ${r}`,e,n)}dataOut(t,r,e,n){this.info(t,`\u2190 ${r}`,e,n)}success(t,r,e,n){this.info(t,`\u2713 ${r}`,e,n)}failure(t,r,e,n){this.error(t,`\u2717 ${r}`,e,n)}timing(t,r,e,n){this.info(t,`\u23F1 ${r}`,n,{duration:`${e}ms`})}happyPathError(t,r,e,n,o=""){let a=((new Error().stack||"").split(`
`)[2]||"").match(/at\s+(?:.*\s+)?\(?([^:]+):(\d+):(\d+)\)?/),_=a?`${a[1].split("/").pop()}:${a[2]}`:"unknown",p={...e,location:_};return this.warn(t,`[HAPPY-PATH] ${r}`,p,n),o}},$=new m;var l=require("fs"),O=require("path"),x=require("os");var k="bugfix,feature,refactor,discovery,decision,change",F="how-it-works,why-it-exists,what-changed,problem-solution,gotcha,pattern,trade-off";var f=class{static DEFAULTS={CLAUDE_MEM_MODEL:"claude-sonnet-4-5",CLAUDE_MEM_CONTEXT_OBSERVATIONS:"50",CLAUDE_MEM_WORKER_PORT:"37777",CLAUDE_MEM_WORKER_HOST:process.platform==="win32"?"0.0.0.0":"127.0.0.1",CLAUDE_MEM_SKIP_TOOLS:"ListMcpResourcesTool,SlashCommand,Skill,TodoWrite,AskUserQuestion",CLAUDE_MEM_PROVIDER:"claude",CLAUDE_MEM_CLAUDE_AUTH_METHOD:"cli",CLAUDE_MEM_GEMINI_API_KEY:"",CLAUDE_MEM_GEMINI_MODEL:"gemini-2.5-flash-lite",CLAUDE_MEM_GEMINI_RATE_LIMITING_ENABLED:"true",CLAUDE_MEM_OPENROUTER_API_KEY:"",CLAUDE_MEM_OPENROUTER_MODEL:"xiaomi/mimo-v2-flash:free",CLAUDE_MEM_OPENROUTER_SITE_URL:"",CLAUDE_MEM_OPENROUTER_APP_NAME:"claude-mem",CLAUDE_MEM_OPENROUTER_MAX_CONTEXT_MESSAGES:"20",CLAUDE_MEM_OPENROUTER_MAX_TOKENS:"100000",CLAUDE_MEM_DATA_DIR:(0,O.join)((0,x.homedir)(),".claude-mem"),CLAUDE_MEM_LOG_LEVEL:"INFO",CLAUDE_MEM_PYTHON_VERSION:"3.13",CLAUDE_CODE_PATH:"",CLAUDE_MEM_MODE:"code",CLAUDE_MEM_CONTEXT_SHOW_READ_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_WORK_TOKENS:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_AMOUNT:"true",CLAUDE_MEM_CONTEXT_SHOW_SAVINGS_PERCENT:"true",CLAUDE_MEM_CONTEXT_OBSERVATION_TYPES:k,CLAUDE_MEM_CONTEXT_OBSERVATION_CONCEPTS:F,CLAUDE_MEM_CONTEXT_FULL_COUNT:"5",CLAUDE_MEM_CONTEXT_FULL_FIELD:"narrative",CLAUDE_MEM_CONTEXT_SESSION_COUNT:"10",CLAUDE_MEM_CONTEXT_SHOW_LAST_SUMMARY:"true",CLAUDE_MEM_CONTEXT_SHOW_LAST_MESSAGE:"false",CLAUDE_MEM_FOLDER_CLAUDEMD_ENABLED:"false",CLAUDE_MEM_EXCLUDED_PROJECTS:"",CLAUDE_MEM_FOLDER_MD_EXCLUDE:"[]"};static getAllDefaults(){return{...this.DEFAULTS}}static get(t){return this.DEFAULTS[t]}static getInt(t){let r=this.get(t);return parseInt(r,10)}static getBool(t){let r=this.get(t);return r==="true"||r===!0}static applyEnvOverrides(t){let r={...t};for(let e of Object.keys(this.DEFAULTS))process.env[e]!==void 0&&(r[e]=process.env[e]);return r}static loadFromFile(t){try{if(!(0,l.existsSync)(t)){let i=this.getAllDefaults();try{let c=(0,O.dirname)(t);(0,l.existsSync)(c)||(0,l.mkdirSync)(c,{recursive:!0}),(0,l.writeFileSync)(t,JSON.stringify(i,null,2),"utf-8"),console.log("[SETTINGS] Created settings file with defaults:",t)}catch(c){console.warn("[SETTINGS] Failed to create settings file, using in-memory defaults:",t,c)}return this.applyEnvOverrides(i)}let r=(0,l.readFileSync)(t,"utf-8"),e=JSON.parse(r),n=e;if(e.env&&typeof e.env=="object"){n=e.env;try{(0,l.writeFileSync)(t,JSON.stringify(n,null,2),"utf-8"),console.log("[SETTINGS] Migrated settings file from nested to flat schema:",t)}catch(i){console.warn("[SETTINGS] Failed to auto-migrate settings file:",t,i)}}let o={...this.DEFAULTS};for(let i of Object.keys(this.DEFAULTS))n[i]!==void 0&&(o[i]=n[i]);return this.applyEnvOverrides(o)}catch(r){return console.warn("[SETTINGS] Failed to load settings, using defaults:",t,r),this.applyEnvOverrides(this.getAllDefaults())}}};var E=require("path"),w=require("os");var b=require("url");var nt={};function et(){return typeof __dirname<"u"?__dirname:(0,E.dirname)((0,b.fileURLToPath)(nt.url))}var Lt=et(),T=f.get("CLAUDE_MEM_DATA_DIR"),D=process.env.CLAUDE_CONFIG_DIR||(0,E.join)((0,w.homedir)(),".claude"),rt=(0,E.join)(D,"plugins","marketplaces","claude-mem"),Ct=(0,E.join)(T,"archives"),mt=(0,E.join)(T,"logs"),dt=(0,E.join)(T,"trash"),Ut=(0,E.join)(T,"backups"),Rt=(0,E.join)(T,"modes"),It=(0,E.join)(T,"settings.json"),ht=(0,E.join)(T,"claude-mem.db"),Nt=(0,E.join)(T,"vector-db"),yt=(0,E.join)(T,"observer-sessions"),vt=(0,E.join)(D,"settings.json"),Pt=(0,E.join)(D,"commands"),$t=(0,E.join)(D,"CLAUDE.md");var Ht=y(L.HEALTH_CHECK);var A=null;function G(){if(A!==null)return A;let s=H.default.join(f.get("CLAUDE_MEM_DATA_DIR"),"settings.json"),t=f.loadFromFile(s);return A=parseInt(t.CLAUDE_MEM_WORKER_PORT,10),A}async function _t(){try{let s=N(),{readJsonFromStdin:t}=await Promise.resolve().then(()=>(K(),X)),r=await t(),e=G(),n=await fetch(`http://127.0.0.1:${e}/api/sessions/${s}/observation`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({observation:r})});if(!n.ok)throw new Error(`Failed to save observation: ${n.status}`);return console.log(JSON.stringify({continue:!0,suppressOutput:!1,exitCode:3})),3}catch(s){return console.error(JSON.stringify({error:s instanceof Error?s.message:String(s),exitCode:2})),2}}0&&(module.exports={handlePostToolUse});
